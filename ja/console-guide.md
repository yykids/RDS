## Database > RDS for MySQL > コンソール使用ガイド

## 開始する

RDS for MysQLを使用するには、先にDBインスタンスを作成する必要があります。DBインスタンスは次の方法で作成できます。

* **Console > Database > RDS for MySQL**の **DB Instance **タブで左上の **+ 作成** ボタンをクリックすると、下図のようにページの下に入力画面が現れます。

![rds_01_20190723](https://static.toastoven.net/prod_rds/19.07.23/rds_01_20190723_jp.png)

* **詳細設定** 画面に表示された必須項目をすべて入力した後、画面右上の **次へ** ボタンをクリックします。
    * DB Instance：DBインスタンス名を入力します。
    * 説明：DBインスタンスの説明を入力します。
    * DB Engine：作成するデータベースエンジンバージョンを選択します。
    * DB Port：データベースのポート番号を入力します。 
        * 10000～12000の間で設定できます。
    * DB User ID：データベース作成時に作成される管理者アカウントIDを入力します。
    * DB Password：データベース作成時に作成される管理者アカウントパスワードを入力します。
    * VPC Subnet：作成するDBインスタンスとprivate network通信をするCompute & Networkサービスのサブネットを選択します。
    * Floating IP：TOASTクラウド外部ネットワークと接続する場合、Floating IPを使用に設定します。
    * Flavor：DBインスタンスのタイプを選択します。
    * Storageタイプ：DBインスタンスボリュームのタイプを指定します。
        * HDDおよびSSDを選択できます。
    * Storage：DBインスタンスボリュームのサイズを入力します。 
        * 20GB～1,000GBのサイズで作成できます。
    * Availabillity Zone：DBインスタンスが作成される領域を選択します。
    * 高可用性：DBインスタンスを作成する時、Masterとは異なるAvailability ZoneにCandidate Masterを作成します。
    * DBファイルの暗号化：ユーザーデータファイルおよびバックアップファイルを暗号化します。
    * 基本アラーム：DBインスタンスのイベントのうち、定義されているイベントに対するアラームを登録できます。
        * 基本アラーム使用時、受信グループを選択する必要があります。

> [参考] 選択したCompute & NetworkサービスのVPCサブネットがインターネットゲートウェイと接続されていない場合、Floating IPを使用できません。
> [参考] 一度選択したVPCサブネットは変更できません。
> [参考] Candidate Masterインスタンスは、必ずMasterと異なるAvailability Zoneに作成され、リストに表示されません。
> [参考] インスタンスリストは、各インスタンスの作成順にソートされ、Candidate MasterはMasterの高可用性オプション使用時点で作成されるため、フェイルオーバー後、インスタンスの順序が変わる場合があります。
> [参考] DBファイル暗号化機能を使用すると、パフォーマンスが多少低下する場合があります。
> [参考] 基本アラーム使用時、該当インスタンスに対するアラームが自動的に登録され、名前は"{インスタンス名}-default"に設定されます。登録されるアラームは変更および削除することができ、適用されるインスタンスも変更できます。

**バックアップ&アクセス制御** 画面でバックアップ情報を指定します。

![rds_02_20190723](https://static.toastoven.net/prod_rds/19.07.23/rds_02_20190723_jp.png)

* 自動バックアップおよびアクセス制御を設定した後、 **次へ** ボタンをクリックします。
* バックアップ保管期間：自動バックアップをするには、1日以上を選択します。
    **なし**を選択すると、自動バックアップが行われません。
* バックアップ開始時刻：自動バックアップはバックアップ開始時刻からDurationの間の任意の時点に始まります。
    * Durationはバックアップが始まる時刻を意味します。 
    * Duration内にバックアップが終了することを意味するわけではありません。
* ユーザーアクセス制御：DBインスタンスにアクセス可能なユーザーをCIDR形式で入力します。
    * ユーザーアクセス制御に登録されていないIPは接続できません。

DB Configuration画面で設定値を変更できます。

![rds_03_20190723](https://static.toastoven.net/prod_rds/19.07.23/rds_03_20190723_jp.png)

* 設定値を変更した後、 **作成** ボタンをクリックします。
* 最後に **確認** ボタンをクリックすると、DBインスタンスが作成されます。
* 作成されるまで、数分から数十分かかります。

### DBインスタンス接続

* 作成されたDBインスタンスを選択すると、詳細設定を確認できます。 
* インスタンス[詳細設定]の[接続情報]で、接続可能なドメイン情報を確認できます。
* Floating IPを‘使用’に設定していないDBインスタンスは、外部からアクセスできません。


1. 外部から接続をテストするために右上の **変更** ボタンをクリックします。
2. Floating IP項目を **使用する**に修正します。
3. **確認** ボタンをクリックすると、修正事項が反映されます。

![rds_04_20190723](https://static.toastoven.net/prod_rds/19.07.23/rds_04_20190723_jp.png)

* 設定後、Floating IPが作成され、外部からアクセスできることを確認できます。

![rds_05_20190723](https://static.toastoven.net/prod_rds/19.07.23/rds_05_20190723_jp.png)

* 次はMySQL Workbenchの接続例です。

![rds_06_20190723](https://static.toastoven.net/prod_rds/19.07.23/rds_06_20190723_jp.png)

#### 制約事項

* ユーザーComputeサービスのインスタンスがdnsサーバーに接続できないネットワーク環境の場合、該当インスタンスはドメインを通してRDSインスタンスに接続できません。

## DBインスタンス

### 高可用性

* 別のAvailability ZoneにCandidate Masterを作成して障害が発生した時、フェイルオーバーを行うことができます。
* 高可用性インスタンスを再起動する時、[フェイルオーバーを利用した再起動]オプションを選択し、MasterとCandidate Masterを交換できます。
* 高可用性を使用したインスタンスの場合、一部オプションを変更する時、接続情報は変わりませんが、MasterとCandidate Masterインスタンスは変わる場合があります。
* 障害が発生し、高可用性インスタンスにフェイルオーバーが実行された時、変更された新しいMasterインスタンスは、既存のMasterインスタンスのバックアップを継承しません。

#### 制約事項

* 高可用性インスタンスは、最初の1回のフェイルオーバーを保障します。障害が発生してフェイルオーバーした場合、Candidate Masterインスタンスが高可用性機能を使用しない一般Masterに変更されます。
* 変更された新しいMasterインスタンスは、既存Masterインスタンスの接続に使用されるドメインを継承します。
* また、高可用性オプションを新たに指定して使用できます。
* フェイルオーバーを行った既存のMasterインスタンスは、接続情報が変更され、’中止’状態に変わります。
* フェイルオーバーを行った既存のMasterインスタンスは、インスタンス再起動機能を利用して再起動を試行できますが、障害によるデータ損失などの理由で再起動できなかったり、正常に作動しない場合があります。
* Read Only Slaveインスタンスには高可用性機能を提供しません。
* 高可用性機能を使用するインスタンスを再起動したり、オプションを変更する間は、該当インスタンスのRead Only Slave操作ができなくなります。
* 高可用性機能はドメインを基盤にしているため、ユーザーのComputeサービスのインスタンスがdnsサーバーに接続できないネットワーク環境の場合、該当インスタンスはドメインを通してRDSインスタンスに接続することができず、障害措置発生時、正常に接続できません。


### インスタンスタイプ

* TOAST Compute & Networkサービスで提供するすべてのタイプでDBインスタンスを作成できます。

### バックアップ

* RDSでは、すべてのバックアップを実行した後、作成したバックアップを独自のObject Storageにアップロードして保管します。
* 自動バックアップに限り、原本インスタンスのデータボリュームサイズ分のバックアップ容量を無料で提供します。
* 別途料金を希望しない場合は、バックアップ周期を調整する必要があります。
* バックアップの実行中は、性能が低下することがあります。
* サービスに影響を与えないようにするには、サービスの負荷が小さい時間にバックアップを行ってください。
* TOAST RDSは時点復元をサポートします。
    * バイナリログ(binary log)サイズと保管周期が短すぎる場合、希望する時点に復元するのが困難な場合があります。
* 復元中のDBインスタンスはバックアップできません。

#### 自動バックアップ

* DBインスタンスのバックアップ周期を1日以上に設定すると、自動バックアップが有効になります。
    * バックアップ周期を1日以上から、なしに変更すると、即時にすべての自動バックアップはサーバーから削除されます。
    * 削除されたバックアップは復元できません。
* 設定されたバックアップ周期分、バックアップファイルを維持します。
* 自動バックアップは、バックアップ開始時刻からDurationの間の任意の時点に始まります。
* Durationはバックアップが始まる時刻を意味します。 Duration内にバックアップが完了するということではありません。
    * Duration内にバックアップを完了できなくてもバックアップは終了しません。
* 自動バックアップは、原本インスタンスを全て削除する場合、一緒に削除されます。

#### 手動バックアップ

* 自動バックアップ以外に、いつでも手動でバックアップできます。
* 手動バックアップは、明示的に削除しない限り削除されません。

### 復元

* 保管されたバックアップを利用して、希望する時点にDBインスタンスを復元できます。
* 復元時、原本DBインスタンスを変更せず、新しいDBインスタンスを作成します。
* バックアップの保存位置がObject Storageにある場合、さらに時間がかかります。
* バックアップ中のDBインスタンスを利用して復元できません。
> [参考]復元の進行中、Binary Logファイルのサイズ分、Object Storage使用量が発生することがあります。
> [参考]バイナリログファイルがない時は、時点復元ができません。

### コピー

* 読み取り性能高めるには、MySQLがサポートするRead Only Slaveを作成します。
* Read Only Slaveを作成するには、原本DBインスタンスを選択した後、 **追加機能 > コピー作成**をクリックします。

![rds_07_20190723](https://static.toastoven.net/prod_rds/19.07.23/rds_07_20190723_jp.png)

* コピー作成のための設定を入力し、 **コピー** ボタンをクリックすると、コピーが作成されます。
* 原本DBインスタンスと同じタイプまたはさらに高いタイプでの作成を推奨します。低いタイプで作成した場合、コピー遅延が発生することがあります。
* コピー作成時、原本DBインスタンスのI/O性能が通常より低下することがあります。
* 原本DBインスタンスのサイズに比例して、コピー作成時間が増加することがあります。
> [参考]コピーの進行中、バイナリログファイルのサイズ分、Object Storage使用量が発生することがあります。
> [参考]複製が完了すると、Masterインスタンスのアクセスルール(access rule)項目にRead Only Slaveのルールが追加されます。 

#### 制約事項

* 1つの原本インスタンスは、最大5個のコピーを作成することができます。
* コピーのコピーは作成できません。

### 昇格

* コピー関係を切り、Read Only SlaveからMasterに変更することを昇格と呼びます。
* 昇格したコピーは、原本DBインスタンスの修正事項を自動的に反映しません。
* 昇格したコピーは、独立したDBインスタンスとして動作するようになります。
* 昇格するコピーと原本DBインスタンスの間にコピー遅延がある場合、遅延がなくなるまで昇格されません。

### 容量の確保

*  DBインスタンスのリソースを削除し、ディスク容量を確保できます。

#### バイナリログ削除

![rds_08_20190723](https://static.toastoven.net/prod_rds/19.07.23/rds_08_20190723_jp.png)

* バイナリログファイルを削除してディスクスペースを確保します。

>[注意]選択した対象バイナリログファイルと、それ以前に作成されたバイナリログファイルがすべて削除されます。
>[注意]バイナリログファイルを削除した時、削除したバイナリログファイルによっては特定時点に復元できない場合もあります。
>[注意]バイナリログファイルを全て削除した時は、時点復元を使用できません。


### ストレージ拡張

![rds_09_20190723](https://static.toastoven.net/prod_rds/19.07.23/rds_09_20190723_jp.png)

* DBインスタンスのストレージサイズを拡張します。
* Read Only Slaveが存在する場合、Masterと同じストレージサイズに拡張されます。
* 対象DBインスタンスが再起動します。

### DBファイルの暗号化

* ユーザーデータが保存されるデータベースファイルおよびバックアップファイルを暗号化します。

> [参考]リアルタイムに暗号化を行うため、DBインスタンスのパフォーマンスが多少低下する場合があります。

#### 制約事項

* DBファイルの暗号化機能を使用しないインスタンスから復元または複製をした時、DBファイルの暗号化機能を有効にできません。
* DBファイルの暗号化機能を使用するインスタンスから復元また複製をした時、DBファイルの暗号化機能を無効にできません。

## モニタリング

* RDSはDB運営および使用に必要なモニタリング項目を周期的に収集し、チャートで表示します。
* 特定DBインスタンスのモニタリング項目を見たい場合は、**DB Instance** リストから特定DBインスタンスを選択し、 **Monitoring** タブを選択します。

![rds_10_20190723](https://static.toastoven.net/prod_rds/19.07.23/rds_10_20190723_jp.png)

* 特定DBインスタンスのモニタリング項目を見たい場合は、**Monitoring** タブで希望するDBインスタンスを選択し、 **追加** ボタンをクリックします。
* チャート範囲、間隔、種類および項目を変更すると、変更事項が追加されたすべてのDBインスタンスに影響を与えます。

![rds_11_20190723](https://static.toastoven.net/prod_rds/19.07.23/rds_11_20190723_jp.png)

* チャートの範囲を簡単に調整できるボタンを使用できます。
* 1時間、6時間などのボタンを押すと、現在の時刻を基準に自動でfrom～toを計算してアップデートします。
<br/>
* チャート範囲よって選択できるチャート間隔が異なります。
    * 2時間以内：1分、10分
    * 12時間以内：10分、 1時間
    * 4日以内：1時間、 6時間
    * 2週以内：6時間、1日
    * それ以外：1日
* チャート種類は、最大値と平均値をサポートします。

> [参考] RDS DBインスタンス別モニタリングデータは、ユーザーDBインスタンスの'rds_maintenance'というデータベースに臨時で保存されて削除されます。したがって作成した後、何も動作していないインスタンスでも、いくつかのモニタリング項目が規則的に動くグラフ形式が現れることがあります。
> [参考] rds_maintenance databaseのデータを操作すると、正確ではないモニタリングデータが収集されることがあります。

### モニタリング項目

* RDSでサポートするモニタリング項目は次のとおりです。

![rds_12_20190723](https://static.toastoven.net/prod_rds/19.07.23/rds_12_20190723_jp.png)

### ログファイル

* DBインスタンスに接続しなくても、ログファイルの閲覧やダウンロードができます。
* **DB Instance**を選択した後、 **Events & Log** タブをクリックすると、error.log, slow_query.log, general.logファイルを閲覧できます。

![rds_13_20190723](https://static.toastoven.net/prod_rds/19.07.23/rds_13_20190723_jp.png)

* また、必ず **DB Configuration**でログを残すように設定する必要があります。
* **参照** ボタンをクリックすると、新しいウィンドウでログファイルを閲覧できます。
* ログの長さに入力されたライン数だけ閲覧でき、終わりから512KBサイズのログを閲覧できます。

![rds_14_20190723](https://static.toastoven.net/prod_rds/19.07.23/rds_14_20190723_jp.png)

* ログファイル全体を閲覧したい場合、 **ダウンロード** ボタンをクリックして直接ファイルをダウンロードする必要があります。

![rds_15_20190723](https://static.toastoven.net/prod_rds/19.07.23/rds_15_20190723_jp.png)

* **ダウンロード** ボタンをクリックすると、新しいウィンドウが表示されます。
* **取得** ボタンをクリックして少し待つと、 **ダウンロード** ボタンが有効になり、ダウンロードできるようになります。
* ログファイルは臨時Object Storageにアップロードされ、最大5分間ダウンロードできるようになります。
> [参考] Object Storageにアップロードされ、削除される5分間にObject Storage使用料金がかかることがあります。


## イベント

* RDSはDBインスタンスで発生した意味あるイベントを自動的に残します。
* 特定DBインスタンスで発生したイベントを確認したい場合、DBインスタンスを選択した後、 **詳細設定** 画面の **Event & Log** タブで確認できます。
* マイDBインスタンスで発生したイベントを一度に確認するには、 **Event** タブに移動して確認できます。

![rds_16_20190723](https://static.toastoven.net/prod_rds/19.07.23/rds_16_20190723_jp.png)

* **タイプ**は、どのリソースで発生したイベントかを指します。
    * INSTANCE：DBインスタンスに関連するイベントです。
    * BACKUP：バックアップに関連するイベントです。
* **Identifier**は、イベントが発生したリソースを指します。
    * イベントタイプがINSTANCEの場合、DBインスタンス名が表示されます。
    * イベントタイプがBACKUPの場合、バックアップIDが表示されます。

## Notification

RDSは、希望するリソースで発生する特定イベント通知を受信グループに伝達できます。

1. 希望する通知を設定するには、 **Notification** タブで **作成** ボタンをクリックします。
2. 希望する通知の名前を入力し、 **通知設定**で設定するイベントとリソースを選択します。
 設定後、 **追加** ボタンをクリックします。
3. 通知を受ける受信グループを作成するには **作成** ボタンをクリックします。
4. [受信対象]ウィンドウが表示されたら受信グループ名を入力します。プロジェクトメンバーのうち、通知メッセージを受信するメンバーをクリックし、受信対象プロジェクトメンバーに選択します。
 **追加** ボタンをクリックします。
5. 受信対象ウィンドウで **作成** ボタンをクリックします。
6. 通知設定を完了した後、 **作成** ボタンをクリックします。 

![rds_17_20190723](https://static.toastoven.net/prod_rds/19.07.23/rds_17_20190723_jp.png)

設定した条件を満たすと、受信対象に入力したメールアドレスと電話番号で通知を受け取ることができます。

![rds_18_20190723](https://static.toastoven.net/prod_rds/19.07.23/rds_18_20190723_jp.png)

> [参考]受信グループでチェックボックスを選択していない対象には、メール/SMSが送信されません。

## 부록1. 하이퍼바이저 점검을 위한 DB 인스턴스 마이그레이션 가이드

TOAST는 주기적으로 DB 인스턴스의 하이퍼바이저 소프트웨어를 업데이트하여 보안과 안정성을 향상시키고 있습니다.
점검 대상 하이퍼바이저에서 구동 중인 DB 인스턴스는 마이그레이션을 통해 점검이 완료된 하이퍼바이저로 이동해야 합니다.

DBインスタンスのマイグレーションはTOASTコンソールで開始できます。
DB構成に応じて特定DBインスタンスを選択してマイグレーションする時、関連するDBインスタンス(例えばSlaveインスタンス)もメンテナンス対象の場合は一緒にマイグレーションを進行します。
下記のガイドに従ってコンソールにあるマイグレーション機能を利用してください。
メンテナンス対象に指定されたDBインスタンスがあるプロジェクトに移動します。

### 1. メンテナンス対象DBインスタンスを確認します。

名前の横にマイグレーションボタンがあるDBインスタンスがメンテナンス対象のインスタンスです。

![rds_planed_migration_0](https://static.toastoven.net/prod_rds/planned_migration_alarm/image0_ja.png)

マイグレーションボタンにマウスオーバーすると、メンテナンス日程の詳細を確認できます。

![rds_planed_migration_1](https://static.toastoven.net/prod_rds/planned_migration_alarm/image1_ja.png)

### 2. メンテナンス対象DBインスタンスに接続中のアプリケーションソフトウェアを終了する必要があります。

DBに接続しているサービスに影響を与えないように、適切な措置を取ってください。
やむを得ずサービスに影響を与えてしまう時は、TOASTサポートに連絡してくだされば、適切な措置を案内いたします。

### 3. メンテナンス対象DBインスタンスを選択してマイグレーションボタンをクリックし、DBインスタンスマイグレーションの確認ウィンドウが表示されたら確認ボタンをクリックします。

![rds_planed_migration_2](https://static.toastoven.net/prod_rds/planned_migration_alarm/image2_ja.png)

### 4. DBインスタンスのマイグレーションが終わるまで待機します。

DBインスタンスの状態が変更されない場合は「更新」を行ってください。

![rds_planed_migration_3](https://static.toastoven.net/prod_rds/planned_migration_alarm/image3_ja.png)

DBインスタンスのマイグレーション中は何も操作ができません。
DBインスタンスのマイグレーションが正常に完了しなかった場合、自動的に管理者に報告され、TOASTから別途連絡いたします。